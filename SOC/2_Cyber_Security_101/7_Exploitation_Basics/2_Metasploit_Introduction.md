# Metasploit: Introduction

## Mục lục

1. [Task 1: Introduction to Metasploit](#task-1-introduction-to-metasploit)
2. [Task 2: Main Components of Metasploit](#task-2-main-components-of-metasploit)



## Nội dung

# Task 1: Introduction to Metasploit

**Giới thiệu về Metasploit**

Metasploit là framework khai thác được sử dụng rộng rãi nhất. Metasploit là một công cụ mạnh mẽ có thể hỗ trợ tất cả các giai đoạn của một bài kiểm thử xâm nhập, từ thu thập thông tin cho đến hậu khai thác.

Metasploit có hai phiên bản chính:

* **Metasploit Pro**: Phiên bản thương mại hỗ trợ tự động hóa và quản lý các tác vụ. Phiên bản này có giao diện người dùng đồ họa (GUI).
* **Metasploit Framework**: Phiên bản mã nguồn mở hoạt động từ dòng lệnh. Phòng lab này sẽ tập trung vào phiên bản này, được cài đặt trên AttackBox và thường được sử dụng trong kiểm thử xâm nhập trên các bản phân phối Linux.

Metasploit Framework là tập hợp các công cụ cho phép thu thập thông tin, quét, khai thác, phát triển exploit, hậu khai thác và nhiều hơn nữa. Mặc dù mục đích chính của Metasploit Framework là phục vụ cho lĩnh vực kiểm thử xâm nhập, nó cũng hữu ích trong nghiên cứu lỗ hổng và phát triển exploit.

Các thành phần chính của Metasploit Framework có thể được tóm tắt như sau:

* **msfconsole**: Giao diện dòng lệnh chính.
* **Modules**: Các module hỗ trợ như exploit, trình quét, payload, v.v.
* **Tools**: Các công cụ độc lập hỗ trợ nghiên cứu lỗ hổng, đánh giá lỗ hổng hoặc kiểm thử xâm nhập. Một số công cụ này bao gồm msfvenom, pattern\_create và pattern\_offset. Trong module này, chúng ta sẽ tìm hiểu msfvenom, còn pattern\_create và pattern\_offset là các công cụ hữu ích trong phát triển exploit nhưng nằm ngoài phạm vi của module này.

Phòng lab này sẽ đề cập đến các thành phần chính của Metasploit, cung cấp nền tảng vững chắc để tìm kiếm exploit phù hợp, đặt tham số và khai thác các dịch vụ dễ bị tấn công trên hệ thống mục tiêu. Sau khi hoàn thành phòng lab, bạn sẽ có thể điều hướng và sử dụng thoải mái dòng lệnh của Metasploit.

---

# Task 2: Main Components of Metasploit

**Các thành phần chính của Metasploit**

Khi sử dụng Metasploit Framework, bạn sẽ chủ yếu tương tác với bảng điều khiển Metasploit. Bạn có thể khởi chạy nó từ terminal của AttackBox bằng lệnh `msfconsole`. Bảng điều khiển sẽ là giao diện chính để bạn tương tác với các module khác nhau của Metasploit Framework. Các module là những thành phần nhỏ bên trong Metasploit Framework, được tạo ra để thực hiện một nhiệm vụ cụ thể, chẳng hạn như khai thác lỗ hổng, quét mục tiêu hoặc thực hiện tấn công brute-force.

Trước khi đi sâu vào các module, sẽ hữu ích nếu làm rõ một số khái niệm thường gặp: lỗ hổng (vulnerability), khai thác (exploit) và payload.

* **Exploit**: Một đoạn mã sử dụng lỗ hổng tồn tại trên hệ thống mục tiêu.
* **Vulnerability**: Một lỗi thiết kế, cấu hình hoặc logic ảnh hưởng đến hệ thống mục tiêu. Khai thác lỗ hổng có thể dẫn đến việc tiết lộ thông tin bí mật hoặc cho phép kẻ tấn công thực thi mã trên hệ thống mục tiêu.
* **Payload**: Một exploit sẽ tận dụng lỗ hổng. Tuy nhiên, nếu chúng ta muốn exploit đạt được kết quả mong muốn (truy cập hệ thống mục tiêu, đọc thông tin bí mật, v.v.), chúng ta cần sử dụng payload. Payload là đoạn mã sẽ chạy trên hệ thống mục tiêu.

Các module và danh mục dưới đây được liệt kê cho mục đích tham khảo, nhưng bạn sẽ tương tác với chúng thông qua bảng điều khiển Metasploit (`msfconsole`).

**Auxiliary**
Bất kỳ module hỗ trợ nào, chẳng hạn như các trình quét, crawler và fuzzer, có thể được tìm thấy tại đây.

```bash
root@ip-10-10-135-188:/opt/metasploit-framework/embedded/framework/modules# tree -L 1 auxiliary/
auxiliary/
├── admin
├── analyze
├── bnat
├── client
├── cloud
├── crawler
├── docx
├── dos
├── example.py
├── example.rb
├── fileformat
├── fuzzers
├── gather
├── parser
├── pdf
├── scanner
├── server
├── sniffer
├── spoof
├── sqli
├── voip
└── vsploit

20 directories, 2 files
```

**Bộ mã hóa (Encoders)**

Bộ mã hóa cho phép bạn mã hóa exploit và payload với hy vọng rằng các giải pháp chống virus dựa trên chữ ký sẽ bỏ sót chúng.

Các giải pháp chống virus và bảo mật dựa trên chữ ký có một cơ sở dữ liệu chứa các mối đe dọa đã biết. Chúng phát hiện mối đe dọa bằng cách so sánh các tệp đáng ngờ với cơ sở dữ liệu này và đưa ra cảnh báo nếu có sự trùng khớp. Do đó, bộ mã hóa có thể chỉ đạt tỷ lệ thành công hạn chế vì các giải pháp chống virus có thể thực hiện các kiểm tra bổ sung.


```bash
root@ip-10-10-135-188:/opt/metasploit-framework/embedded/framework/modules# tree -L 1 encoders/
encoders/
├── cmd
├── generic
├── mipsbe
├── mipsle
├── php
├── ppc
├── ruby
├── sparc
├── x64
└── x86

10 directories, 0 files
```

**Tránh né (Evasion)**

Mặc dù bộ mã hóa sẽ mã hóa payload, chúng không nên được coi là một nỗ lực trực tiếp để né tránh phần mềm chống virus. Ngược lại, các module “evasion” sẽ cố gắng thực hiện điều đó, với mức độ thành công nhiều hoặc ít tùy trường hợp.


```bash
root@ip-10-10-135-188:/opt/metasploit-framework/embedded/framework/modules# tree -L 2 evasion/
evasion/
└── windows
    ├── applocker_evasion_install_util.rb
    ├── applocker_evasion_msbuild.rb
    ├── applocker_evasion_presentationhost.rb
    ├── applocker_evasion_regasm_regsvcs.rb
    ├── applocker_evasion_workflow_compiler.rb
    ├── process_herpaderping.rb
    ├── syscall_inject.rb
    ├── windows_defender_exe.rb
    └── windows_defender_js_hta.rb

1 directory, 9 files
```

**Exploit**

Các exploit được sắp xếp gọn gàng theo hệ thống mục tiêu.

```bash
root@ip-10-10-135-188:/opt/metasploit-framework/embedded/framework/modules# tree -L 1 exploits/
exploits/
├── aix
├── android
├── apple_ios
├── bsd
├── bsdi
├── dialup
├── example_linux_priv_esc.rb
├── example.py
├── example.rb
├── example_webapp.rb
├── firefox
├── freebsd
├── hpux
├── irix
├── linux
├── mainframe
├── multi
├── netware
├── openbsd
├── osx
├── qnx
├── solaris
├── unix
└── windows

20 directories, 4 files
```

**NOPs**

NOPs (No OPeration) thực sự không làm gì cả. Trong họ CPU Intel x86, chúng được biểu diễn bằng mã 0x90, sau đó CPU sẽ không làm gì trong một chu kỳ. Chúng thường được sử dụng như một bộ đệm để đạt được kích thước payload đồng nhất.


```bash
root@ip-10-10-135-188:/opt/metasploit-framework/embedded/framework/modules# tree -L 1 nops/
nops/
├── aarch64
├── armle
├── cmd
├── mipsbe
├── php
├── ppc
├── sparc
├── tty
├── x64
└── x86

10 directories, 0 files
```

**Payloads**

Payload là các đoạn mã sẽ chạy trên hệ thống mục tiêu.

Exploit sẽ tận dụng một lỗ hổng trên hệ thống mục tiêu, nhưng để đạt được kết quả mong muốn, chúng ta sẽ cần một payload. Ví dụ có thể bao gồm: lấy shell, tải phần mềm độc hại hoặc backdoor lên hệ thống mục tiêu, chạy một lệnh, hoặc khởi chạy `calc.exe` như một bản minh chứng để đưa vào báo cáo kiểm thử xâm nhập. Việc khởi động ứng dụng máy tính (`calc.exe`) trên hệ thống mục tiêu từ xa là một cách an toàn để chứng minh rằng chúng ta có thể chạy lệnh trên hệ thống mục tiêu.

Việc chạy lệnh trên hệ thống mục tiêu đã là một bước quan trọng, nhưng việc có một kết nối tương tác cho phép bạn gõ lệnh và lệnh đó sẽ được thực thi trên hệ thống mục tiêu thì còn tốt hơn. Một dòng lệnh tương tác như vậy được gọi là **shell**. Metasploit cung cấp khả năng gửi các payload khác nhau có thể mở shell trên hệ thống mục tiêu.


```bash
root@ip-10-10-135-188:/opt/metasploit-framework/embedded/framework/modules# tree -L 1 payloads/
payloads/
├── adapters
├── singles
├── stagers
└── stages

4 directories, 0 files
```

Bạn sẽ thấy bốn thư mục khác nhau trong payloads: adapters, singles, stagers và stages.

* **Adapters**: Bộ chuyển đổi bao bọc payload đơn để chuyển chúng sang các định dạng khác. Ví dụ: một payload đơn thông thường có thể được bao bọc trong bộ chuyển đổi **Powershell**, bộ này sẽ tạo ra một lệnh powershell duy nhất để thực thi payload.
* **Singles**: Payload độc lập (thêm người dùng, khởi chạy notepad.exe, v.v.) không cần tải thêm thành phần bổ sung để chạy.
* **Stagers**: Chịu trách nhiệm thiết lập kênh kết nối giữa Metasploit và hệ thống mục tiêu. Hữu ích khi làm việc với staged payloads. “Staged payloads” sẽ tải lên trước một stager trên hệ thống mục tiêu, sau đó tải xuống phần còn lại của payload (stage). Điều này có lợi vì kích thước ban đầu của payload sẽ tương đối nhỏ so với khi tải toàn bộ payload một lần.
* **Stages**: Được tải xuống bởi stager. Điều này cho phép bạn sử dụng các payload có kích thước lớn hơn.

Metasploit có một cách tinh tế để giúp bạn phân biệt payload đơn (còn gọi là “inline”) và payload theo giai đoạn:

* `generic/shell_reverse_tcp`
* `windows/x64/shell/reverse_tcp`

Cả hai đều là reverse shell cho Windows. Loại đầu tiên là payload inline (đơn), được biểu thị bằng dấu gạch dưới `_` giữa “shell” và “reverse”. Trong khi loại thứ hai là payload theo giai đoạn (staged), được biểu thị bằng dấu gạch chéo `/` giữa “shell” và “reverse”.

**Post**
Các module Post sẽ hữu ích ở giai đoạn cuối của quá trình kiểm thử xâm nhập đã đề cập ở trên, tức giai đoạn hậu khai thác.


```bash
root@ip-10-10-135-188:/opt/metasploit-framework/embedded/framework/modules# tree -L 1 post/
post/
├── aix
├── android
├── apple_ios
├── bsd
├── firefox
├── hardware
├── linux
├── multi
├── networking
├── osx
├── solaris
└── windows

12 directories, 0 files
```

Nếu bạn muốn tìm hiểu kỹ hơn về các module này, bạn có thể tìm thấy chúng trong thư mục **modules** của bản cài đặt Metasploit.
Đối với AttackBox, chúng nằm tại:
`/opt/metasploit-framework/embedded/framework/modules`

---

**Trả lời các câu hỏi bên dưới**

Tên của đoạn mã khai thác một lỗ hổng trên hệ thống mục tiêu là gì?
**Exploit**

Tên của đoạn mã chạy trên hệ thống mục tiêu để đạt được mục tiêu của kẻ tấn công là gì?
**Payload**

Payload độc lập được gọi là gì?
**Singles**

"windows/x64/pingback\_reverse\_tcp" thuộc loại payload singles hay staged?
**singles**

---

